/**
 * User Public Key Seeder
 * 
 * Creates demo public keys for end-to-end encryption.
 * Each user has an active encryption key.
 */

import { sequelize } from './database.js';
import { UserPublicKey } from '../models/UserPublicKey.js';

export const UserPublicKeySeeder = async (users) => {
  try {
    console.log('  Creating public keys...');

    // Generate demo public keys (in real app, these would be generated by clients)
    const generateDemoKey = (userIndex) => {
      // Simulate a base64-encoded public key (512 bytes when decoded)
      const keyData = Buffer.from(`demo_public_key_${userIndex}_${Date.now()}`, 'utf8');
      return keyData.toString('base64');
    };

    const demoKeys = [];

    users.forEach((user, index) => {
      // Each user gets an encryption key
      demoKeys.push({
        id: `750e8400-e29b-41d4-a716-44665544000${index}`,
        user_id: user.id,
        public_key: generateDemoKey(index),
        key_type: 'encryption',
        is_active: true,
        expires_at: null, // No expiration for demo
      });

      // Some users also get signing keys
      if (index % 2 === 0) {
        demoKeys.push({
          id: `750e8400-e29b-41d4-a716-44665544001${index}`,
          user_id: user.id,
          public_key: generateDemoKey(index + 100), // Different key data
          key_type: 'signing',
          is_active: true,
          expires_at: null,
        });
      }
    });

    // Create keys using bulkCreate
    const createdKeys = await UserPublicKey.bulkCreate(demoKeys, {
      validate: true,
      individualHooks: false,
    });

    console.log(`  ✅ Created ${createdKeys.length} public keys`);
    return createdKeys;

  } catch (error) {
    console.error('  ❌ Public key seeding failed:', error);
    throw error;
  }
};

export default UserPublicKeySeeder;